<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Setup</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous" />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.js"
      integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
      crossorigin="anonymous"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='./qrcode/jquery.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='./qrcode/qrcode.js') }}"></script>
</head>
<body>
    <div class="container">
        <div class="row mt-4" style="height: 80vh">
          <div class="col-3"></div>
          <div class="col-6 justify-content-center align-self-center border border-white border-2 p-4 rounded-4 shadow">
            <h1>OTP Setup for {{ username }}</h1>
            {% if error %}
                <p style="color: red;">{{ error }}</p>
            {% endif %}
            <p style="color: red;">You must set up the opt to finish setup your account otherwise you can not find back your password</p>
            <p>Scan this QR code with your OTP app like Microsoft Authenticator:</p>
            <div id="qrcode" style="width:100px; height:100px; margin-top:15px;" class="mb-2">

                
            </div>
            <form method="POST" action="/otp_setting" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-3 me-0" >
                        <label for="otp">Enter OTP:</label>
                    </div>
                    <div class="col-6">
                        <input type="text" id="otp" name="otp" class="form-control" required>
                    </div>
                </div>          
                <button id="submit" class="btn btn-secondary">Verify OTP</button>
            </form>
          </div>
          <div class="col-3"></div>
        </div>
      </div>


     <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
     <script>

        var qrcode = new QRCode(document.getElementById("qrcode"), {
             width : 100,
             height : 100
         });
        function makeCode (elText) {		               
             qrcode.makeCode(elText);
         }
        $(document).ready(function() {
            const provisioningUri = "{{ provisioning_uri }}";
            console.log(provisioningUri); // 打印 provisioningUri 以供调试
            makeCode(provisioningUri); // 生成二维码

    $('#submit').on('click', function() {
        const formData = new FormData();
        // Add all required fields
        formData.append('otp', $('#otp').val());
        $.ajax({
            url: '/otp_setting',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.status === 'success') {
                    // Fixed undefined nickname reference
                    alert(`Welcome, ${$('#userid').val()}! \n You can now login!`);
                    window.location.href = '/login';
                } else {
                    alert(response.message);
                }
            },
            error: function(xhr) {
                const res = xhr.responseJSON || { message: 'Server error' };
                alert(res.message);
                window.location.href = '/otp';
            }
        });
    });
        });
     </script>
</body>
</html>